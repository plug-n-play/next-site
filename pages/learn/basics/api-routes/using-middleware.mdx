import Layout from '../../../../components/learn/Layout';

export const meta = {
  title: 'Using Middleware',
  courseId: 'basics',
  lessonId: 'api-routes',
  stepId: 'using-middleware'
};

In the previous step, we created our Quotes API. Now let's explore the middleware given by NextJS for APIs out of the box.

API routes provide built in middleware which parse the incoming `req`. Let's enhance our API to read query params and filter results accordingly. Make following changes in `pages/api/randomQuote.js`

```bash
import { quotes } from '../../quotes'

export default (req, res) => {
  const author = req.query.author ? req.query.author : ''
  let filteredQuotes = [], randomQuote

  if (author) {
    filteredQuotes = quotes.filter(quote => quote.author.toLowerCase().indexOf(author.toLowerCase()) > -1)

    if(filteredQuotes.length) {
      randomQuote = filteredQuotes[Math.floor(Math.random()*filteredQuotes.length)]
    } else {
      filteredQuotes = quotes.filter(quote => quote.author.toLowerCase().indexOf("unknown") > -1)
      randomQuote = filteredQuotes[Math.floor(Math.random()*filteredQuotes.length)]
    }
  } else {
    randomQuote = quotes[Math.floor(Math.random()*quotes.length)]
  }

  res.status(200).json(randomQuote)
}
```

We are reading `author` from query params and filtering the results accordingly.

Let's read the author from our user interface. Make following changes in `pages/index.js`

```bash
import React, {useState} from 'react'
import useSWR from 'swr'

const fetcher = function(url, author) {
  if (author) url = url + `?author=${author}`
  return  fetch(url).then(r => r.json());
}

const Index = () => {
  let [searchAuthor, setSearchAuthor] = useState('')
  let [queryParams, setQueryParams] = useState({});
  let { data, error } = useSWR(['/api/randomQuote', queryParams], fetcher)

  function getNewQuote(ev) {
    ev.preventDefault()
    setQueryParams(searchAuthor)
  }

  if (error) return <div>failed to load</div>
  if (!data) return <div>loading...</div>

  return (
    <main className="center">
      <div className="quote">
        {data && data.quote}
      </div>
      <span className="author"> - {data && data.author} </span>

      <form id="search">
        <input id="formInput" value={searchAuthor} onChange={event => setSearchAuthor(event.target.value)} />
        <button id="btnSubmit" type="submit" onClick={getNewQuote}>Get Quote</button>
      </form>

      <style jsx>{`
        main {
          width: 90%;
          max-width: 900px;
          margin: 300px auto;
          text-align: center;
        }
        .quote {
          font-family: cursive;
          color: #E243DE;
          font-size: 24px;
          padding-bottom: 10px;
        }
        .author {
          font-family: sans-serif;
          color: #559834;
          font-size: 20px;
        }
        #search {
          margin-top: 200px;
        }
        #formInput {
          width: 100px;
          height: 20px;
          margin: 30px
        }
        #btnSubmit {
          padding: 10px 20px;
          background: #559833;
          color: white;
          border-radius: 10px;
          font-size: 14px;
        }
      `}</style>
    </main>
  )
}

export default Index
```

Now type `rauch` in the search box and try searching. Observe the quote would have got updated.

export default ({ children }) => <Layout meta={meta}>{children}</Layout>;
